# -1. Файловая структура и местоположение

На вашем Mac (пользователь svetaa.) весь проект по «турецким лекарствам» располагается в папке:

/Users/svetaa./Desktop/турецкие лекарства 31-05-25/
Внутри этой папки, на момент последней проверки, находятся следующие файлы и подпапки:

/Users/svetaa./Desktop/турецкие лекарства 31-05-25/
│
├── 27-05-2025-ilac-fiyat (1).xlsx       # Excel-файл с примерами
├── турецкие лекарства 31_05_25 - WEBLISTE.csv   # Основной CSV с исх. данными
├── турецкие лекарства 31_05_25.xlsx      # Аналогичный Excel-формат (не используем)
│
├── form_terms.txt   # Справочник: список форм выпуска (по одному слову/аббревиатуре на строку)
├── dose_units.txt   # Справочник: список единиц дозировки (MG, IU, % и т. д.) по одному слову на строку
│
└── турецкие_лекарства_результат.csv  # Итоговый CSV (он появился после экспорта)
Таким образом, вся работа с исходными данными (парсинг, очистка, генерация новых столбцов) происходит именно в этой папке. Когда мы запускаем Python (в терминале Mac), мы прописываем:

cd ~/Desktop/турецкие\ лекарства\ 31-05-25
python3
— чтобы оказаться в директории /Users/svetaa./Desktop/турецкие лекарства 31-05-25 и затем обращаться к файлам именно по их коротким именам (без полного пути).

2. Что у нас уже есть: исходные файлы и словари

Исходный CSV:
Файл турецкие лекарства 31_05_25 - WEBLISTE.csv содержит примерно 6–7 тысяч строк с колонками:
['Штрихкод', 'Название лекарства', 'Цена', 'Производитель',
 'НДС', 'Фонд', 'Тип цены', 'Скидка применяется?', 'Процент скидки', 'Наценка (%)']
Колонка «Название лекарства» изначально выглядит так (пример первых строк):
BETASERC 16 MG 30 TB.
BETASERC 24 MG 100 TB.
BRUFEN 400 MG 20 FTB.
DUPHALAC 667 MG 300 ML SRP*
ANSIOX 0.5 MG 30 TB **
...
То есть после названий стоят точки (.) и, иногда, звёздочки (*, **) и пробелы.
Словари (текстовые файлы):
form_terms.txt (формы выпуска). Каждая строка — это одна аббревиатура или термин для формы выпуска. Пример полного списка, который у вас сейчас в файле:
TAB
TBL
TABLET
CAP
KAPS
CAPS
KAPSUL
AMP
AMPULE
VIAL
FLK
INJ
INJECTION
SUSP
SUSPENSION
SYR
SYRUP
GEL
CRM
CREAM
UNG
OINT
DROPS
DROP
DRG
DRAGEE
SUPP
SUPPOSITORY
SOL
SOLUTION
PLV
POWDER
ENJ
SPR
SPRAY
SC
EC
RETARD
SR
CR
XR
XL
FTB
FORT
FORTE
RET
P
ML
Здесь обратите внимание: в form_terms.txt есть ML (чтобы «300 ML» при парсинге ушло именно в PACK как фасовка).
Также здесь присутствуют «SR», «RET», «FTB» и т. д., которые отвечают за различные модификаторы («ретард», «суппозиторий» и т. д.).
dose_units.txt (единицы дозировки). Каждая строка — одна единица, но без ML. Пример содержимого:
MG
G
MCG
IU
%
MEQ
UNITS
MCMOL
MMOL
GR
Мы строго разделили:
Все аббревиатуры, относящиеся к фасовке и к форме выпуска (даже объёмы, типа ML), — в form_terms.txt.
Все аббревиатуры, относящиеся только к единицам дозировки (MG, IU, % и т. д.), — в dose_units.txt.
Результирующий файл:
После того как мы применили парсер, мы сохранили весь DataFrame в турецкие_лекарства_результат.csv. В нём (помимо всех исходных колонок) появились четыре новых колонки:
Название лекарства (чисто) | PURE | DOSE | PACK | FORMS
Структура результирующего CSV теперь такова:
Штрихкод, Название лекарства, Цена, Производитель, НДС, Фонд, Тип цены, Скидка применяется?, Процент скидки, Наценка (%), 
Название лекарства (чисто), PURE, DOSE, PACK, FORMS
3. Пошаговый алгоритм, который мы реализовали

Ниже приведена подробно расписанная последовательность действий (код, разделённый на этапы). Это то, что уже работает у вас:

Этап 1. Загрузка исходного CSV
import pandas as pd

# 1.1. Читаем CSV
file_path = "турецкие лекарства 31_05_25 - WEBLISTE.csv"
df = pd.read_csv(file_path, dtype=str, encoding="utf-8-sig")

# 1.2. Убедимся, что есть колонка «Название лекарства»:
print("Колонки после загрузки:", df.columns.tolist())
# Должны увидеть: ['Штрихкод', 'Название лекарства', 'Цена', 'Производитель', 'НДС',
#                 'Фонд', 'Тип цены', 'Скидка применяется?', 'Процент скидки', 'Наценка (%)']
В результате вы видите, что df загружен, а в нём присутствуют все исходные колонки.

Этап 2. Очистка «Название лекарства» от точек, звёздочек и лишних пробелов
# 2.1. Создаём новый столбец «Название лекарства (чисто)»:
df['Название лекарства (чисто)'] = (
    df['Название лекарства']
      .astype(str)
      # Убираем все завершающие: точки (.), звёздочки (*), пробелы (\s) 
      .str.replace(r"[.\*\s]+$", "", regex=True)
      # Убираем дефисы/пробелы в начале-окончании, если они есть
      .str.replace(r"^[-\s]+|[-\s]+$", "", regex=True)
)

# 2.2. Проверяем первые 10 значений «чистого» названия:
print("=== Первые 10 строк «чистого» названия ===")
print(df[['Название лекарства (чисто)']].head(10).to_string(index=True))
Результат вывода покажет первые 10 строк уже без точек (.), без *, без пробелов в конце:
   Название лекарства (чисто)
0  BETASERC 16 MG 30 TB
1  BETASERC 24 MG 100 TB
2  BETASERC 24 MG 20 TB
3  BETASERC 24 MG 60 TB
4  BETASERC 8 MG 30 TB
5  BRUFEN 400 MG 20 FTB
6  BRUFEN 600 MG 20 TB
7  BRUFEN RET 800 MG 14 FTB
8  DAROB 80 MG 50 TB
9  DICETEL 50 MG 40 FTB
Теперь все лишние символы убраны, и колонка «Название лекарства (чисто)» готова к дальнейшему разбору.

Этап 3. Подготовка справочников (form_terms и dose_units)
# 3.1. Функция для загрузки списка терминов из файла
def load_terms(filename):
    with open(filename, encoding='utf-8') as f:
        return [line.strip().upper() for line in f if line.strip()]

# 3.2. Загружаем form_terms и dose_units
form_terms = [x for x in load_terms("form_terms.txt") if x not in load_terms("dose_units.txt")]
dose_units = load_terms("dose_units.txt")

# 3.3. Убедимся, что форм и доз не пересекаются:
print("Form terms:", form_terms)
print("Dose units:", dose_units)
form_terms.txt должен содержать только все возможные варианты форм выпуска (включая «ML», «SR», «FTB» и т. д.).
dose_units.txt должен содержать только единицы дозировки (без «ML»).
Если в выводе form_terms вы видите, что там нет ни «MG», ни «IU», ни «%», а только аббревиатуры форм — значит всё правильно.

Этап 4. Функция разбора на PURE/DOSE/PACK/FORMS
import re
import pandas as pd

def better_parse_drug_name(name, form_terms, dose_units):
    """
    name: строка, уже очищенная от точек/звёздочек (uppercase).
    Возвращает pd.Series с четырьмя элементами:
      [pure, dose, pack, forms]
    где:
      pure  – «чистое название» (удалены все цифры, дозы, формы),
      dose  – первая встреченная доза (например, «100MG», «0.5ML», «%10»),
      pack  – первая встреченная фасовка (число + форма из form_terms, например «30TB», «300ML»),
      forms – все оставшиеся формы выпуска после удаления dose и pack (например «SR», «RET», «FTB», «ENJ»).
    """

    name_up = name.upper()

    # 1) ДОЗИРОВКА: ищем первую пару «число + единица из dose_units»
    dose_pattern = r"(\d+(?:[\.,]\d+)?\s*(%s))" % "|".join(dose_units)
    dose_match = re.search(dose_pattern, name_up)
    dose = dose_match.group(0).replace(" ", "") if dose_match else ""

    # 2) ФАСОВКА: ищем первую пару «число + форма из form_terms»
    pack_pattern = r"(\d+\s?(%s))" % "|".join(form_terms)
    pack_match = re.search(pack_pattern, name_up)
    pack = pack_match.group(0).replace(" ", "") if pack_match else ""

    # 3) Удаляем найденные dose и pack из строки, чтобы дальше найти остальные формы
    name_cut = name_up
    if dose:
        name_cut = name_cut.replace(dose, "")
    if pack:
        name_cut = name_cut.replace(pack, "")

    # 4) ВСЕ ОСТАВШИЕСЯ ФОРМЫ ВЫПУСКА: например «SR», «FTB», «ENJ», «PED» и т. д.
    form_pattern = r"\b(" + "|".join(form_terms) + r")\b"
    forms = " ".join(re.findall(form_pattern, name_cut))

    # 5) PURE: удаляем dose, pack и все forms из исходной строки
    tmp = name_up
    for to_remove in [dose, pack] + forms.split():
        if to_remove:
            tmp = re.sub(r"\b{}\b".format(re.escape(to_remove)), "", tmp)
    pure = tmp.strip()
    # Оставляем ровно один пробел между словами
    pure = re.sub(r"\s+", " ", pure)

    return pd.Series([pure, dose, pack, forms])
Этап 5. Применяем функцию к каждому «чистому» названию и проверяем первые 50 строк
# 5.1. Обновляем справочники (на случай, если вы что-то дополняли в form_terms.txt)
form_terms = [x for x in load_terms("form_terms.txt") if x not in load_terms("dose_units.txt")]
dose_units = load_terms("dose_units.txt")

# 5.2. Применяем функцию к столбцу «Название лекарства (чисто)»
df[['PURE', 'DOSE', 'PACK', 'FORMS']] = df[
    'Название лекарства (чисто)'
].apply(lambda x: better_parse_drug_name(x, form_terms, dose_units))

# 5.3. Выводим первые 50 строк, чтобы убедиться, что всё разделилось корректно:
pd.set_option('display.max_colwidth', 30)
print("=== Первые 50 строк после разбора ===")
print(df[
    ['Название лекарства (чисто)', 'PURE', 'DOSE', 'PACK', 'FORMS']
].head(50).to_string(index=True))
Как должен выглядеть результат (пример первых 10 строк, остальные аналогично):

    Название лекарства (чисто)    |   PURE         |   DOSE   |   PACK    |  FORMS
-------------------------------------------------------------------------------------
0   BETASERC 16 MG 30 TB          | BETASERC       | 16MG     | 30TB      | TB
1   BETASERC 24 MG 100 TB         | BETASERC       | 24MG     | 100TB     | TB
2   BETASERC 24 MG 20 TB          | BETASERC       | 24MG     | 20TB      | TB
3   BETASERC 24 MG 60 TB          | BETASERC       | 24MG     | 60TB      | TB
4   BETASERC 8 MG 30 TB           | BETASERC       | 8MG      | 30TB      | TB
5   BRUFEN 400 MG 20 FTB          | BRUFEN         | 400MG    | 20FTB     | FTB
6   BRUFEN 600 MG 20 TB           | BRUFEN         | 600MG    | 20TB      | TB
7   BRUFEN RET 800 MG 14 FTB      | BRUFEN RET     | 800MG    | 14FTB     | RET FTB
8   DAROB 80 MG 50 TB             | DAROB          | 80MG     | 50TB      | TB
9   DICETEL 50 MG 40 FTB          | DICETEL        | 50MG     | 40FTB     | FTB
В PURE теперь должно быть только название «BETASERC», «BRUFEN», «DAROB» и т. д., без цифр и без «MG», «TB», «FTB» и т. д.
DOSE = «16MG», «400MG», «80MG» и т. п.
PACK = «30TB», «20FTB», «50TB» и т. д.
FORMS = оставшиеся формы, например «FTB», «RET FTB», «TB» и т. д.
Если вы увидите, что какое-то сочетание осталось неправильно (например, «PED» или «TOP» всё ещё в PURE), нужно просто добавить этот термин (PED, TOP или COZ и т. д.) в файл form_terms.txt и перезапустить пункт 5.2. После этого всё ROS (REST OF STRINGS — все оставшиеся фрагменты) корректно окажутся в FORMS, а в PURE уже ничего лишнего не будет.

Этап 6. Экспорт финальной таблицы
Когда вы убедились, что PURE действительно содержит только чистое название, а DOSE, PACK и FORMS заполнены правильно:

# 6.1. Сохраняем результат в CSV
df.to_csv(
    "турецкие_лекарства_результат.csv",
    index=False,
    encoding="utf-8-sig"
)
print("✅ Финальный файл сохранён как 'турецкие_лекарства_результат.csv'")
Теперь у вас есть окончательная таблица турецкие_лекарства_результат.csv с такой структурой:

Штрихкод, Название лекарства, Цена, Производитель, НДС, Фонд, Тип цены, Скидка применяется?, Процент скидки, Наценка (%),
Название лекарства (чисто), PURE, DOSE, PACK, FORMS
4. Итоговая система парсинга

Исходный CSV (турецкие лекарства 31_05_25 - WEBLISTE.csv) лежит в папке /Users/svetaa./Desktop/турецкие лекарства 31-05-25/.
После загрузки мы сразу смотрим, какие колонки есть и убеждаемся, что поле «Название лекарства» именно такое.
Этап 1: Создаём столбец Название лекарства (чисто), где у каждого значения из «Название лекарства» удаляем точку/звёздочку/пробел(ы) в самом конце.
Этап 2: Повторно «strip» по краям, чтобы убрать возможные дефисы или пробельные символы в начале/конце.
Этап 3: Подготовка словарей (тексты form_terms.txt и dose_units.txt), в которых:
form_terms.txt содержит ТОЛЬКО формы выпуска (каждый термин на новой строке), включая «ML», чтобы «100 ML» распознавался именно как фасовка.
dose_units.txt содержит ТОЛЬКО единицы дозирования (MG, IU, % и т. д.), без «ML».
Удаление пересечений: если в form_terms.txt случайно попали «MG» или «IU», они отфильтровываются при загрузке через строку
form_terms = [x for x in load_terms("form_terms.txt") if x not in load_terms("dose_units.txt")]
Этап 4: Функция better_parse_drug_name(...), которая:
Ищет первую дозировку (число + единица из dose_units).
Ищет первую фасовку (число + форма из form_terms).
Удаляет найденные dose + pack из строки, чтобы дальше найти все оставшиеся формы (через re.findall).
Удаляет из строки всё найденное (dose, pack и все forms) и выдаёт «чистое название» (PURE) — без цифр и без сокращений.
Этап 5: Применяем better_parse_drug_name к каждому «чистому» названию (Название лекарства (чисто)), получаем новые столбцы PURE, DOSE, PACK, FORMS.
Этап 6: Экспортируем финальную таблицу в турецкие_лекарства_результат.csv.
5. Вопросы для уточнения

Достаточен ли текущий набор форм в form_terms.txt?
В строках, которые мы проверяли, часто встречаются:
SRP, ENJ, PED, TOP, COZ, POM, CIGN, KKH, RET и т. д.
Если вы заметили, что какие-то из этих или других сокращений всё ещё остаются в PURE (а не в FORMS), нужно добавить их в form_terms.txt. Есть ли ещё “редкие” или “специфичные” термины, которых нет в текущем form_terms.txt?
Что делать с комбинациями «TARKA 180/2 MG 28 FTB» или «TEVETEN PLUS 600/12.5 MG 2 …»
Иногда дозировка записана как «180/2 MG» или «600/12.5 MG». Функция сейчас захватывает (\d+(?:[\.,]\d+)?)\s*(MG) → выдерживает оба формата. Но в редких случаях могут быть дополнительные символы (например, «TARKA 180/2 MG 28 FTB» → DOSE=180/2MG, PACK=28FTB). Всё ли корректно обрабатывается?
Есть ли особые случаи, когда названия содержат «с компьютера» какие-то несловесные символы (например, апострофы, кавычки, нестандартные тире) помимо . и *?
Если что-то такое встречается, рекомендуется дополнить регулярку r"[.\*\s]+$" (которая сейчас убирает только . и *) ещё и какими-то другими символами (например, умные кавычки или «нестандартное» тире). Нужно ли их включить?
Настройка логирования ошибок:
В будущем можно захотеть сохранить в отдельный файл все строки, где PURE оказался пустым или где DOSE/PACK не найдены (например, названия без цифр вовсе). Хотите ли вы сейчас добавить этап логирования таких «нераспарсенных» случаев?
Это можно сделать, например, так:
unparsed = df[df['PURE'] == ""]
unparsed.to_csv("нераспарсенные_строки.csv", index=False, encoding="utf-8-sig")
Аналогично можно сохранить, где не нашли DOSE или не нашли PACK.
Форматирование итоговой таблицы:
Достаточно ли вам простого CSV, или нужно добавить ещё какие-то столбцы, например, дата обработки, версия скрипта, количество обработанных строк (чтобы потом видеть, что обработано 6732 строки)?
Может понадобиться колонка PARSE_STATUS с флагом «OK»/«NO_DOSE»/«NO_PACK» и т. д. Для этого нужно на этапе 5 проверять, пустые ли DOSE или PACK.
Где далее использовать результат?
Вы планируете импортировать финальный CSV турецкие_лекарства_результат.csv в WordPress/CRM?
Есть ли требования по кодировке (UTF-8 сигнатура vs без BOM)? Мы сейчас сохраняем encoding="utf-8-sig", чтобы Excel корректно открыл файл, но для импорта в CMS может быть достаточно utf-8.
Возможно, нужно выгрузить не только CSV, но и JSON или сразу залить в базу данных? Если да, дайте знать, чтобы я показал, как конвертировать DataFrame в другие форматы.
После ваших ответов на эти пункты я смогу:
Скорректировать или дополнить form_terms.txt/dose_units.txt, если обнаружатся недостающие термины.
Добавить этап логирования «нераспарсенных» строк.
Подготовить финальный CSV точно под ваши требования (например, без BOM или в виде TSV).
Учесть любые специфические кейсы (например, «180/2 MG» → «180/2MG» или «%» в середине).
Пожалуйста, расскажите:

Есть ли ещё какие-то особые сокращения (PED, COZ, POM, CIGN, KKH, SS, etc.), которые мы упустили?
Нужны ли дополнительные проверки/логи по «неполным парсам»?
В каком формате (и куда) будет дальше использоваться результат?
Это поможет точно выстроить финальную систему парсинга в соответствии с вашими задачами.
